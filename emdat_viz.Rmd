---
title: "EMDAT Visualizations"
author: "Ram Mukund Kripa"
date: "8/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(here)
library(rnaturalearth)

```

```{r dataget}
brazil_clean <- read_csv(file = here("clean_data","Brazil.csv")) %>%
  select(-c("Latitude","Longitude"))
indsl_clean <- read_csv(file = here("clean_data","India_SriLanka.csv"))%>%
  select(-c("Latitude","Longitude"))
dis_types <- c("Flood","Storm","Landslide","Drought")
emdat_hydros <- bind_rows(brazil_clean,indsl_clean) %>%
  filter(`Disaster Type` %in% dis_types)


```

```{r bounds}
bounds <- read_csv(file = here("data","region_boxes_csv.csv"))

in_reg <- function(latitude,longitude,region_name){
  reg <- bounds %>%
    filter(Region == region_name)
  in_box <- (latitude<=reg$Lat_max & latitude>=reg$Lat_min
                    &longitude<=reg$Lng_max & longitude>=reg$Lng_min)
  return(in_box)
}

new_any <- function(vec){
  resy <- NA
  for (i in vec){
    if (is.na(i)){
      
    }
    else if (i==TRUE) {
      return(TRUE)
    }
    else{
      resy <- FALSE
    }
  }
  return(resy)
}
```

# USING LAT LONG BOXES

## Brazil Map
```{r}

braz_map <- ne_countries(country = "Brazil",
                         returnclass = "sf")

emdat_inbox <- emdat_hydros %>%
  rowwise() %>%
  mutate(in_the_box = in_reg(lat,long,region),
         `Dis No` = as_factor(`Dis No`),
         `Start Month` = as.numeric(`Start Month`))

emdat_inbox %>%
  filter(region=="Brazil") %>%
  drop_na(lat) %>%
ggplot()+
  geom_sf(data = braz_map)+
   geom_point(mapping = aes(y = lat, x = long, color = in_the_box))+
  labs(title = "Brazil Map",
       color = "In Lat Long Box")


  


```

```{r}
emdat_inbox %>%
  group_by(`Dis No`) %>%
  summarize(region_name = region, any_in_box = new_any(in_the_box)) %>%
  group_by(any_in_box) %>%
  summarize(count = n())
```

```{r}
library(patchwork)

region_plots <- function(region_name){
  
diz <- emdat_inbox %>%
  filter(region==region_name) %>%
  group_by(`Dis No`) %>%
  summarize(start_month = mean(`Start Month`),
            year = mean(Year),
            any_in_box = new_any(in_the_box)) %>%
  mutate(start_month = as_factor(start_month)) %>%
  drop_na(any_in_box)

p1 <- diz %>%
  group_by(any_in_box,start_month) %>%
  summarize(count = n()) %>%
  ggplot(mapping = aes(x = start_month, y = count, fill = any_in_box))+
  geom_col(position = "dodge")

p2 <- diz %>%
  filter(any_in_box == TRUE) %>%
  group_by(year) %>%
  summarize(count = n()) %>%
  ggplot(mapping = aes(x = year, y = count))+
  geom_line()

return(p1+p2+plot_annotation(title = glue::glue("Plots for ",region_name)))
}

region_plots("Brazil")
  
  
```
## India and Sri Lanka Map

```{r}
library(rgeos)

ind_map <- ne_countries(country = "India",
                          returnclass = "sf")
sl_map <- ne_countries(country = "Sri Lanka",
                          returnclass = "sf")

emdat_inbox %>%
  filter(region=="India_SriLanka") %>%
  drop_na(lat) %>%
ggplot()+
  geom_sf(data = ind_map)+
  geom_sf(data = sl_map)+
   geom_point(mapping = aes(y = lat, x = long, color = in_the_box))+
  labs(title = "Ind/Sl Map",
       color = "In Lat Long Box")

```

```{r}
region_plots("India_SriLanka")
```


# USING SHAPEFILES

```{r indsl}

library(sf)
north_hem_shap <- st_read(here("shape_data","NH_mask.shp"))
south_hem_shap <- st_read(here("shape_data","SH_mask.shp"))
ggplot()+
  geom_sf(data = ne_countries(returnclass = "sf"), color = "red")+
  geom_sf(data = north_hem_shap, color = "green", fill = "skyblue")+
  geom_sf(data = south_hem_shap, color = "black", fill = "purple")

  
```

## Inside shapefile?

```{r}
library(maptools)
library(rgdal)
library(sp)

sp1 <- readShapeSpatial(here("shape_data","NH_mask.shp"),
                        proj4string = CRS("+init=epsg:25832"))
sp2 <- emdat_inbox %>%
  filter(region == "India_SriLanka") %>%
  drop_na(lat) %>%
  select(lat,long) %>%
  SpatialPoints(proj4string = CRS(proj4string(sp1)))

gContains(sp1,sp2)

```
## In shape checking function
```{r}
shapesy <- list()
shapesy[["nh"]] <- readShapeSpatial(here("shape_data","NH_mask.shp"),
                        proj4string = CRS("+init=epsg:25832"))
shapesy[["sh"]] <- readShapeSpatial(here("shape_data","SH_mask.shp"),
                        proj4string = CRS("+init=epsg:25832"))

in_shape <- function(lat,long){
  if (lat>0){
    sp1 <- shapesy[["nh"]]
  }
  else {
    sp1 <- shapesy[["sh"]]
  }
sp2 <- tibble(lat,long) %>%
  SpatialPoints(proj4string = CRS(proj4string(sp1)))

gCovers(sp1,sp2)
}

emdat_inbox %>%
  filter(region == "India_SriLanka") %>%
  head(n = 6L) %>%
  rowwise() %>%
  mutate(in_shapey = in_shape(lat,long))
  
in_shape(11.93,79.82)
```
## Using SF
```{r}
points_df <- emdat_inbox %>%
  drop_na(lat) %>%
  head(n= 7L) %>%
  select(lat,long)
points_sf <- st_as_sf(points_df,
                      coords = c("lat","long"),
                      crs = st_crs(south_hem_shap))
a_point <- st_sfc(st_point(c(-7,-34)),
                  crs = st_crs(south_hem_shap))
st_contains(x = a_point,
            y = south_hem_shap,
            sparse = FALSE)
st_crs(a_point)
plot(south_hem_shap)
```


```{r}

```