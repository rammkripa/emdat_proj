---
title: "EMDAT disasters"
author: "Ram Mukund Kripa"
date: `r lubridate::today()`
output: github_document
---
## Setup:

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)

```

## Packages:

```{r packages}

library(tidyverse)
library(here)
library(gganimate)
library(readxl)

```

## Reading the data:

```{r readdata}
read_emdat <- function(stringy_path){
  read_excel(path = stringy_path,
             skip = 6,
             col_names = TRUE)
}
files <- list.files(path = here("data"),
                    pattern = ".xlsx")

listy <- list()

for (file_name in files){
  
  file_name_trimmed <- tools::file_path_sans_ext(basename(file_name))
  
  listy[[file_name_trimmed]] <- read_emdat(here("data",file_name))
  
}

emdat_dirty <- bind_rows(listy,.id = "region")
glimpse(emdat_dirty)
```

## Tidying The Data as Given

```{r cleaning}
emdat_clean <- emdat_dirty %>%
  drop_na(Location) %>%
  filter(`Disaster Subgroup` %in% c("Meteorological",
                                    "Climatological",
                                    "Hydrological")) %>%
  mutate(Latitude = as.numeric(Latitude),
         Longitude = as.numeric(Longitude),
         Year = as.numeric(Year),
         `Start Month` = as_factor(`Start Month`)
         ) %>%
  drop_na(`Start Month`) 
emdat_clean

```

## A Function to obtain the Lat and Long of the top three results for a place

```{r latlongfunc}

library(geonames)
library(countrycode)
get_lat_long <- function(location_name,country_name){
  country_code <- countrycode(sourcevar = country_name,
                              origin = "country.name",
                              destination = "iso2c")
  options(geonamesUsername = "rammkripa")
  return_list <- GNsearch(q = location_name,
                          country = country_code,
                          type = "json"
                          )
    return_list %>%
      select(toponymName,lat,lng) %>%
      head(n = 3L) %>%
      mutate(lat = as.numeric(lat),lng = as.numeric(lng))
}
## Testing Logic
pondi_results <- get_lat_long("Pondicherry","India")
pondi_results
  
  
```

## Function to check if places in a list are in the box specified

```{r funcinbox}

### Writing a function to check if a list of places has at least one location whose lat long is in the box
### Function should call get_lat_long
### first load bounds
bounds <- read_csv(here("data","region_boxes_csv.csv"))

is_in_box <- function(locations,country_name,region_name){
  locations_spl <- stringr::str_split(locations,pattern=", ")[[1]]
  results <- list()
  for (loc in locations_spl){
    reg <- bounds %>%
      filter(Region == region_name)
    results[[loc]] <- tryCatch(
      {
        loc_df <- get_lat_long(loc,country_name) %>%
                  mutate(in_box = (lat<=reg$Lat_max & lat>=reg$Lat_min
                    &lng<=reg$Lng_max & lng>=reg$Lng_min))
        #results[[loc]] <-
        any(loc_df$in_box)
      },
      error = function(e){
        NA
      }
    )
  }
  return(results)
}

## Testing
is_in_box(locations = "Pondicherry, Tamil Nadu, Rajasthan",
          country_name = "India",
          region_name = "India_SriLanka")


```

## Filtering places that are in the box of interest

```{r cleaningfinal}
my_any <- function(listy){
  rez <- NA
  for(i in seq_along(listy)){
    val = listy[[i]]
    if (is.na(val)){
      stringy <- "dummy"
    }
    else if (val == TRUE){
      return(TRUE)
    }
    else if (val == FALSE ) {
      rez <- FALSE
    }
  }
  return(rez)
}

clean_func <- function(listE){
  
    result <- tryCatch(
      {my_any(is_in_box(listE[[1]],
                listE[[2]],
                listE[[3]]))},
      error = function(e){
        e
      }
                )
 
   return(result)   
}
# Testing clean_func

list("Location" = "Pondicherry, Tamil Nadu, Jaipur",
     "Country" = "India",
     "region" = "India_SriLanka")%>%
clean_func()

```

## Testing my_any
```{r}
any(FALSE,NA,"error","blahblah")
xl <- list("x" = FALSE,
           "y" = NA,
           "z" = "err")
my_any(xl)
```

## Cleaning Brazil data (a test)

```{r}

brazil_dat <- emdat_clean %>%
  filter(region == "Brazil")

brazil_dat$in_region <- brazil_dat %>%
  select(Location,Country,region) %>%
  apply(1,clean_func)

brazil_dat %>%
  summarize(perc_NA = mean(is.na(in_region)))

brazil_dat %>%
  drop_na(in_region) %>%
  ggplot(mapping = aes(x = `Start Month`,fill = in_region))+
  geom_bar(stat = "count", position = "dodge")+
  labs(y = "Number of Disasters",
       title = "No of Disasters by Start Month",
       fill = "In Region of Interest")

```

```{r}

emdat_clean$in_region <- emdat_clean %>%
  select(Location,Country,region) %>%
  apply(1,clean_func)

emdat_clean %>%
  summarize(count_NA = sum(is.na(in_region)))

new_df <- emdat_clean %>%
  select(Location,Country,in_region)
  


```

## Session info

```{r, echo = TRUE}
devtools::session_info()
```