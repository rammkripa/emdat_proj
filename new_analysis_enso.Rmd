---
title: "ENSO analysis new"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r}
library(tidyverse)
library(sf)
library(here)
library(weed)
library(rnaturalearth)
library(rnaturalearthdata)
```

## Loading In the Data

```{r}
emdat <- read_csv(here("full_emdat_geocoded_finally.csv"))
```
# How many disasters were located?

```{r}
emdat %>%
  percent_located_disasters(plot_result=FALSE)
```

# How many locations were located?

```{r}
emdat %>%
  percent_located_locations(plot_result=FALSE)
```
# All types of disasters

```{r}
emdat %>%
  group_by(`Disaster Type`) %>%
  count()
```

# Restrict to dry and wet hydrological disasters

```{r}
dry_list <- c("Drought", "Extreme temperature", "Wildfire")
wet_list <- c("Flood", "Landslide", "Storm")

emdat_hydrological <- emdat %>%
  filter(`Disaster Type` %in% c(dry_list, wet_list)) %>%
  mutate(dry = (`Disaster Type` %in% dry_list), wet = (`Disaster Type` %in% wet_list))
```

```{r}
emdat_hydrological %>%
  group_by(`Disaster Type`) %>%
  count()
```

# ENSO data

```{r}
enso_data <- read_csv(here("data","enso_data_copy2.csv"))
enso_data %>%
  group_by(Event) %>%
  count()
```

```{r}
emdat_hydrological_enso <- emdat_hydrological %>%
  full_join(enso_data, by = c("Year" = "Year", "Start Month" = "MonthNum")) %>%
  rename("enso_Value" = "Value") %>%
  filter(!is.na(`Start Month`)) %>%
  mutate(start_year = if_else(is.na(`Start Year`), Year, `Start Year`)) %>%
  mutate(end_year = if_else(is.na(`End Year`), start_year, `End Year`)) %>%
  mutate(end_month = if_else(is.na(`End Month`), `Start Month`, `End Month`)) %>%
  mutate(num_months_disaster = (end_month - `Start Month` + 1) + 12 * (end_year - start_year)) %>%
  filter(num_months_disaster > 0)

emdat_hydrological_enso %>%
  group_by(num_months_disaster) %>%
  summarize(count_disasters = n_distinct(`Dis No`))
```

```{r}
emdat_hydrological_enso %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  mutate(enso_positive = (enso_Value > 0)) %>%
  group_by(`Dis No`) %>%
  summarize(enso_pos = any(enso_positive),enso_val = mean(enso_Value), is_wet = any(wet)) %>%
  ggplot(mapping = aes(x = enso_val, fill = is_wet)) +
    geom_histogram(stat = "density") +
    facet_grid(~is_wet) +
  ggtitle("Counts of Disasters compared to value of ONI with wet disasters in Blue and Dry in Red")
```
```{r}
emdat_hydrological_enso %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  #mutate(enso_positive = (enso_Value > 0)) %>%
  group_by(`Dis No`) %>%
  summarize(enso_event = first(Event),enso_val = mean(enso_Value), is_wet = any(wet), is_dry = any(dry)) %>%
  mutate(is_wet_num = as.numeric(is_wet), is_dry_num = as.numeric(is_dry)) %>%
  group_by(enso_event) %>%
  summarize(num_disasters_wet = sum(is_wet_num), num_disasters_dry = sum(is_dry_num))
```
```{r}
world_map <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

emdat_hydrological_enso %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(enso_positive = (enso_Value > 0)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  select(lng, lat, enso_Value, wet_string) %>%
  #head(n = 50L) %>%
  ggplot() +
  geom_sf(data = world_map) +
  geom_tile(mapping = aes(x = lng, y = lat, fill = enso_Value, width = 2, height = 2)) +
  scale_fill_gradient2(low="blue", mid = "white", high = "red") +
  facet_grid(~wet_string)
  

```
```{r}

emdat_hydrological_enso %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  select(lng, lat, Event_factor, wet_string, wet) %>%
  ggplot() +
  geom_sf(data = world_map) +
  geom_tile(mapping = aes(x = lng, y = lat, width = 2, height = 2, fill = 1, alpha = 0.001)) +
  facet_grid(cols = vars(wet_string), rows = vars(Event_factor))

```
```{r}

event_num_months <- enso_data %>%
  group_by(Event) %>%
  summarize(num_months = n())

emdat_hydrological_enso %>%
  left_join(event_num_months, by = c("Event")) %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  select(lng, lat, Event_factor, wet_string, num_months, num_months_disaster) %>%
  add_row(lng = 1, lat = 1, Event_factor = 'no_event', wet_string = 'dry_disasters', num_months = 1) %>%
  ggplot() +
  geom_sf(data = world_map) +
  geom_tile(mapping = aes(x = lng, y = lat, width = 2, height = 2, alpha = num_months_disaster/num_months, fill = 'red')) +
  facet_grid(cols = vars(wet_string), rows = vars(Event_factor)) +
  ggtitle("Same plot as above but scaled by num months")

```

```{r}
emdat_hydrological_enso %>%
  left_join(event_num_months, by = c("Event")) %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  select(lng, lat, Event_factor, wet_string, num_months) %>%
  ggplot() +
  geom_sf(data = world_map) +
  stat_bin_2d(mapping = aes(x = lng, y = lat), binwidth = c(2,2)) +
  scale_fill_gradient(trans = 'log', low = 'white', high = 'red') + 
  facet_grid(cols = vars(wet_string), rows = vars(Event_factor)) +
  ggtitle("2D Histogram Counts ")

```
```{r}

emdat_hydrological_enso %>%
  left_join(event_num_months, by = c("Event")) %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  select(lng, lat, Event_factor, wet_string, num_months) %>%
  ggplot() +
  geom_sf(data = world_map) +
  stat_bin_2d(mapping = aes(x = lng, y = lat, fill = ..density..), binwidth = c(2,2)) +
  scale_fill_gradient(trans = 'log', low = 'white', high = 'red') + 
  facet_grid(cols = vars(wet_string), rows = vars(Event_factor)) +
  ggtitle("2D Histogram Density")

```

```{r}

emdat_hydrological_enso %>%
  left_join(event_num_months, by = c("Event")) %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  select(lng, lat, Event_factor, wet_string, num_months, num_months_disaster) %>%
  ggplot() +
  geom_sf(data = world_map) +
  stat_bin_2d(mapping = aes(x = lng, y = lat, weight = num_months_disaster/num_months), binwidth = c(2,2)) +
  scale_fill_gradient(trans = 'log', low = 'white', high = 'red') + 
  facet_grid(cols = vars(wet_string), rows = vars(Event_factor)) +
  ggtitle("2D Histogram Inverse Weighted by Num Months")

```
```{r}
## calculate relative risk within each box
### create boxes acc to resy X resy

resy <- 4

emdat_hydrological_enso %>%
  left_join(event_num_months, by = c("Event")) %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  mutate(lat_box = (as.integer(lat) %/% resy) * resy , lng_box = (as.integer(lng) %/% resy) * resy) %>%
  mutate(dis_no_factor = as_factor(`Dis No`)) %>%
  group_by(lat_box, lng_box, Event_factor, wet_string, dis_no_factor) %>%
  summarize(num_months = first(num_months), num_disaster_month = mean(num_months_disaster)) %>%
  group_by(lat_box, lng_box, Event_factor, wet_string) %>%
  summarize(num_months = first(num_months), num_disaster_months = sum(num_disaster_month)) %>%
  mutate(disaster_rate = num_disaster_months / num_months) %>%
  pivot_wider(id_cols = c(lat_box, lng_box), names_from = c(Event_factor, wet_string), values_from = c(disaster_rate), values_fill = 0) %>%
  mutate(positive_wet_relative_risk = positive_wet_disasters / no_event_wet_disasters, 
         negative_wet_relative_risk = negative_wet_disasters / no_event_wet_disasters, 
         positive_dry_relative_risk =  positive_dry_disasters / no_event_dry_disasters,
         negative_dry_relative_risk = negative_dry_disasters / no_event_dry_disasters) %>%
  select(lat_box, lng_box, positive_wet_relative_risk, negative_wet_relative_risk, positive_dry_relative_risk, negative_dry_relative_risk) %>%
  pivot_longer(cols = c(positive_wet_relative_risk, negative_wet_relative_risk, positive_dry_relative_risk, negative_dry_relative_risk), names_to = 'risk', values_to = 'value') %>%
  mutate(risk_factor = as_factor(risk), values_cleaned = if_else(is.infinite(value), 18, value)) %>%
  mutate(relative_risk_cleaned = if_else(is.nan(values_cleaned), 0, values_cleaned)) %>%
  mutate(relative_risk_cleaned2 = if_else((relative_risk_cleaned) > 2, 2, relative_risk_cleaned)) %>%
  ggplot() +
  geom_sf(data = world_map) +
  geom_tile(mapping = aes(x = lng_box, y = lat_box, fill = relative_risk_cleaned2, width = resy)) +
  scale_fill_gradient2(midpoint = 1, limits = c(0, 2), low = 'cyan', high = 'red') +
  facet_grid(rows = vars(risk_factor))+
  ggtitle("Relative risk plot using calculations of the form [{num_disasters_positive_wet / num_months_positive} / {num_disasters_no_event_wet / num_months_no_event}]")
  
  

```

```{r}
## calculate percent of total disasters within each box
### create boxes 2x2

resy <- 4

emdat_hydrological_enso %>%
  left_join(event_num_months, by = c("Event")) %>%
  filter(!is.na(enso_Value)) %>%
  filter(!is.na(wet)) %>%
  filter(!is.na(lat)) %>%
  mutate(wet_factor = as_factor(wet)) %>%
  mutate(Event_factor = fct_recode(as_factor(Event), no_event = "N", negative = "-", positive = "+")) %>%
  mutate(wet_string = fct_recode(wet_factor, wet_disasters = "TRUE", dry_disasters = "FALSE")) %>%
  mutate(lat_box = (as.integer(lat) %/% resy) * resy , lng_box = (as.integer(lng) %/% resy) * resy) %>%
  mutate(dis_no_factor = as_factor(`Dis No`)) %>%
  group_by(lat_box, lng_box, Event_factor, wet_string, dis_no_factor) %>%
  summarize(num_months = first(num_months), num_disaster_month = mean(num_months_disaster)) %>%
  group_by(lat_box, lng_box, Event_factor, wet_string) %>%
  summarize(num_months = first(num_months), num_disaster_months = sum(num_disaster_month)) %>%
  mutate(disaster_rate = num_disaster_months / num_months) %>%
  pivot_wider(id_cols = c(lat_box, lng_box), names_from = c(Event_factor, wet_string), values_from = c(disaster_rate), values_fill = 0) %>%
  mutate(positive_wet_percent = positive_wet_disasters / (no_event_wet_disasters + positive_wet_disasters + negative_wet_disasters) , 
         negative_wet_percent = negative_wet_disasters / (no_event_wet_disasters + positive_wet_disasters + negative_wet_disasters), 
         positive_dry_percent =  positive_dry_disasters / (no_event_dry_disasters + positive_dry_disasters + negative_dry_disasters),
         negative_dry_percent =  negative_dry_disasters / (no_event_dry_disasters + positive_dry_disasters + negative_dry_disasters)
         ) %>%
  select(lat_box, lng_box, positive_wet_percent, negative_wet_percent, positive_dry_percent, negative_dry_percent) %>%
  pivot_longer(cols = c(positive_wet_percent, negative_wet_percent, positive_dry_percent, negative_dry_percent), names_to = 'typey', values_to = 'value') %>%
  mutate(type_factor = as_factor(typey), values = if_else(is.nan(value), 0, value)) %>%
  ggplot() +
  geom_sf(data = world_map) +
  geom_tile(mapping = aes(x = lng_box, y = lat_box, fill = values, width = resy)) +
  scale_fill_gradient(low = 'white', high = 'red') +
  facet_grid(rows = vars(type_factor))+
  ggtitle("Disaster Percent plot using calculations of the form [positive_wet / all_wet]")
  
  

```